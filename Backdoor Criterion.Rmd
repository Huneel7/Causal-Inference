---
title: "Backdoor Criterion"
output: pdf_document
---

<style type="text/css">

body{
   font-size: 16px;
}

h1.title {
  font-size: 25px;
  color: DarkRed;
}

h1 { /* Header 1 */
  font-size: 20px;
  color: DarkBlue;
}

</style>



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo = FALSE, message = FALSE}
library(dagitty)
library(ggdag)
library(dplyr)
library(ggplot2)
library(tidyverse)
```


# Definition. (The Backdoor Criterion)

*Given an ordered pair of variables (X,Y) in a directed acyclic graph G, a set of variables Z satisfies the backdoor criterion relative to (X, Y) if no node in Z is a descendant of X, and Z blocks every path between X and Y that contains an arrow into X.*

# Causal Effect.

If a set of variables Z satisfies the backdoor criterion for X and Y, then the causal effect of X on Y is given by the formula:

$P(Y=y \mid do(X=x))$ = $\sum_{z}^{} P(Y=y \mid X=x,Z= z)P(Z = z)$

Here, I introduce regime indicator ($F_{X}$) for proof and an example of graphical model to help understanding

```{r, echo = FALSE, message = FALSE, fig.width=10, fig.height=3.2}
g <- dagitty('dag {
    Fx [pos="0,0"]
    X [pos="1,0"]
    Y [pos="2,0"]
    Z [pos="2,1"]
    Fx -> X -> Y 
    Z -> X 
    Z -> Y
}')

ggdag(g)+theme_dag_blank()
```

where probability distribution $P(x_{i} \mid pa(x_{i}, G^{'}))$ is



$P(x_{i} \mid pa(x_{i}, G^{'}) = \begin{cases} P(x_{i} \mid pa(x_{i}, G))\ \ \ \ \  if\ F_{i} = idle \\\\ 1\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ if\ F_{i} = do(x^{'}_{i}) \ and \ x_{i} = x^{'}_{i} \\\\ 0\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ if\ F_{i} = do(x^{'}_{i}) \ and \ x_{i} \neq x^{'}_{i} \end{cases}$

\newpage

# Proof for $P(y \mid do(x)) = \sum_{z}^{} P(y \mid z,x)P(z)$:
$P(y \mid do(x))$

$= \ P(y \mid F_{x} = do(x))$ 

$= \ \sum_{z}^{} P(y, z \mid F_{x} = do(x))$ 

$= \ \sum_{z}^{} P(y \mid z, F_{x} = do(x))P(z \mid F_{x} = do(x))$

$= \ \sum_{z}^{} P(y \mid z,x, F_{x} = do(x))P(z \mid F_{x} = do(x))$

$=^1 \sum_{z}^{} P(y \mid z,x, F_{x} = do(x))P(z)$

$=^2 \sum_{z}^{} P(y \mid z,x)P(z)$ 

(1) By Parental Markov condition (local Markov condition):
A necessary and sufficient condition for a probability distribution P to be Markov relative a DAG G is that every variable be independent of all its nondescendants (in G), conditional on its parents. 

    By this theorem, $F_{x} \perp\!\!\!\perp Z$

(2) $F_{x} \ and \ Y$ are d-separated, conditional on Z and X $=>$ $F_{x} \perp\!\!\!\perp Y \mid Z,X$

# PA(x) always satisfies backdoor criterion:
$P(y \mid pa(x)) = \sum_{z}^{} P(y \mid pa(x),x)P(pa(x))$

# Backdoor Criterion Example.1:
```{r, echo = FALSE, message = FALSE, fig.width=4, fig.height=3}
set.seed(777)
dagify(y ~ x, x ~ z, w ~ z, y ~ w) %>%
  tidy_dagitty() %>%
  mutate(linetype = ifelse(name == "z", "dashed", "solid")) %>% 
  ggplot(aes(x = x, y = y, xend = xend, yend = yend)) +
  geom_dag_edges(aes(edge_linetype = linetype), show.legend = FALSE) +
  geom_dag_point() +
  geom_dag_text() +
  theme_dag() 
```
Here, we are estimating the effect of smoking cigarette (x) on lung function (y). Weight, w, is also measured and we also know the type of jobs affect both weight and the choice to smoke cigarette. However, the study did not record the type of jobs. Though, z is not recorded, we can estimate $P(Y = y \mid do(X = x))$ using the backdoor criterion. Here, w is not a descendant of x and also blocks the backdoor path $x\ \leftarrow \ z\  \rightarrow \ w\  \rightarrow \ y$. 

Thus, $P(Y = y \mid do(X = x))$ = $\sum_{w}^{} P(Y=y \mid X=x,W=w)P(W = w)$


# Backdoor Criterion Example.2:
```{r, echo = FALSE, message = FALSE, fig.width=8, fig.height=5}
g3 <- dagitty('dag {
    Z [pos="-2,1"]
    T [pos="2.4,2"]
    X [pos="2.5,1"]
    Y [pos="3,1"]
    Z [pos="2,1"]
    W [pos="2.3,0"]
    U [pos="2.3,-1"]
    Z -> W -> U 
    X -> W 
    X -> Y
    T -> Z
    T -> Y
}')

ggdag(g3) + theme_dag_blank()
```

Here, we want to estimate the effect of X on Y for a specific value w of W. Though W is a collider and conditioning on W opens a path, T (not a descendant of X) can be used to block the spurious path $X\ \rightarrow \ W\ \leftarrow \ Z\  \leftrightarrow \ T\  \rightarrow \ Y$.

Thus, $P(Y = y \mid do(X = x), W = w)$ = $\sum_{t}^{} P(Y=y \mid X=x,W=w, T=t)P(W = w, T = t)$
